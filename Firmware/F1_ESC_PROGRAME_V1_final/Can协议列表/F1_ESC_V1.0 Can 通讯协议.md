# F1_ESC_V1.0 Can 通讯协议

## 1 链路层配置

* 帧首 int16_t
* 数据 uint8_t-8

* **2字节帧首 1字节功能字 6字节数据位 1字节和校验 波特率1K**
* **功能字与和校验之和为0xFF才记录数据**

## 2 应用层协议

协议数据结构　**8字节**

| 帧首             | 功能字 | 数据  | 和校验 |
| ---------------- | ------ | ----- | ------ |
| 0x301 \| 0x302…… | 1字节  | 6字节 | 1字节  |



## 3   上位机发送

### 3.1 校准命令

* 功能字：0x11

| 编码器帧首 | 功能字 | 数据     | 和检验 |
| ---------- | ------ |  -------  | ------ |
| 0x30x      | 0x10   | 0xF0 | 0xEF   |
| 标准2字节  | 1字节  |  6字节  |1字节|

* 发送该命令后，将自动校准电角度方向，初始零电角度值，电流采样偏差值，自动写明pid方向

* 注意此时电机空载

* 相关参数自动写入 flash 中

* 单独零电角度校准命名

  | 编码器帧首 | 功能字 | 零电角度校准 |数据     | 和检验 |
| ---------- | ------ | -------  | -------  | ------ |
| 0x30x      | 0x10   |0x01  | 0xF0 | 0xEF   |
| 标准2字节  | 1字节 | 1字节        | 5字节 |1字节|

### 3.2 设置命令

* 功能字 0x12
* 可以设置三环的pid参数，设置会自动写入 flash 中
* 三环参数均为 float 类型 通过数据的第一个功能字判断

| 帧首      | 功能字 | 三环声明 | pid声明 | 数据  | 补零 | 和检验 |
| --------- | ------ | -------- | ------- | ----- | ---- | ------ |
| 0x30x     | 0x12   | uint8_t  | uint8_t | float | 0    | 0xEE   |
| 标准2字节 | 1字节  | 1字节    | 1字节   | 4字节 | 0    | 1字节  |

| 三环   | 声明字节 |
| ------ | -------- |
| 电流环 | 0x01     |
| 速度环 | 0x02     |
| 位置环 | 0x03     |

| pid三参数 | 声明字节 |
| --------- | -------- |
| P         | 0x01     |
| I         | 0x02     |
| D         | 0x03     |

### 3.3 pid 查询命令

* 功能字 0x13
* 命令电调发送当前所有的 pid 参数

| 帧首      | 功能字 |  补零 | 和检验 |
| --------- | ------ |  ---- | ------ |
| 0x30x     | 0x13   |  0    | 0xED   |
| 标准2字节 | 1字节  |  0    | 1字节  |

### 3.4 pid 参数保存至flash

* 功能字 0x14
* 命令电调保存当前的 3环 pid 参数

| 帧首      | 功能字 | 补零 | 和检验 |
| --------- | ------ | ---- | ------ |
| 0x30x     | 0x14   | 0    | 0xEC   |
| 标准2字节 | 1字节  | 0    | 1字节  |

### 3.5 超级安全命令

* 功能字 0x15
* 电机使能，断开电源

| 帧首      | 功能字 | 补零  | 和检验 |
| --------- | ------ | ----- | ------ |
| 0x30x     | 0x15   | 0xF0  | 0xEB   |
| 标准2字节 | 1字节  | 6字节 | 1字节  |

### 3.6 电机正常运行

* 功能字 0x16
* 使电机进入正常模式，上电

| 帧首      | 功能字 | 补零  | 和检验 |
| --------- | ------ | ----- | ------ |
| 0x30x     | 0x16   | 0xF0  | 0xEA   |
| 标准2字节 | 1字节  | 6字节 | 1字节  |

### 3.7 设置相关电机参数

* 功能字 0x17
* 设置编码器方向，极对数参数

| 帧首      | 功能字 | 参数选择功能字 | 设置值 | 补零  | 和检验 |
| --------- | ------ | -------------- | ------ | ----- | ------ |
| 0x30x     | 0x17   | uint8_t        | int8_t | 0     | 0xE9   |
| 标准2字节 | 1字节  | 1字节          | 1字节  | 4字节 | 1字节  |

| 控制模式   | 字节声明 |
| ---------- | -------- |
| 编码器方向 | 0x01     |
| 极对数     | 0x02     |
|            |          |

### 3.8 控制命令

* 功能字：0x21
* 可控制电机进行 电流闭环，速度闭环 或 位置闭环

| 帧首      | 功能字 | 控制方式功能字 | 目标参数 | 补零  | 和检验 |
| --------- | ------ | -------------- | -------- | ----- | ------ |
| 0x30x     | 0x21   | uint8_t        | float    | 0     | 0xDF   |
| 标准2字节 | 1字节  | 1字节          | 4字节    | 1字节 | 1字节  |

| 控制模式 | 字节声明 |
| -------- | -------- |
| 电流闭环 | 0x01     |
| 速度闭环 | 0x02     |
| 位置闭环 | 0x03     |

## 4   电调回发

### 4.1 采样数据

* 功能字：0xF1
* 回发传感器采样数据

| 编码器帧首 | 功能字 | 转子角度 | 转子转速 | 电流     | 补零 |  和检验 |
| ---------- | ------ | -------- | -------- | -------- |  ------- | ------ |
| 0x30x      | 0xF1   | int16_t | int16_t | int16_t | 0     | 0x0E   |
| 标准2字节  | 1字节  | 2字节    | 2字节    | 2字节    | 0     | 1字节  |

| 数据内容 | 单位                                |
| -------- | ----------------------------------- |
| 转子角度 | 0.1 ° 度 （-3276.8 ~ 3276.8）       |
| 转子转速 | 0.1 rpm 转每分 （-3276.8 ~ 3276.8） |
| 电流大小 | 0.01 A 安培 （-327.68 ~ -327.68）   |



### 4.2 回发 pid 参数
* 接收到 pid 查询命令 0x13 才发送以下内容
* 功能字：0xE1
* 发送 当前 pid 参数

| 编码器帧首 | 功能字 | 三环声明 | pid声明 | 数据  | 补零 |  和检验 |
| ---------- | ------ | -------- | -------- | -------- |  ------- | ------ |
| 0x30x      | 0xE1  | uint8_t  | uint8_t | float | 0     | 0xE   |
| 标准2字节  | 1字节  | 1字节   | 1字节   | 4字节   | 0     | 1字节  |

| 三环   | 声明字节 |
| ------ | -------- |
| 电流环 | 0x01     |
| 速度环 | 0x02     |
| 位置环 | 0x03     |

| pid三参数 | 声明字节 |
| --------- | -------- |
| P         | 0x01     |
| I         | 0x02     |
| D         | 0x03     |

### 4.3 回发上位机控制命令

* 接收到上位机的除控制命令之外的其他命令，需要进行回发
* 功能字：上位机对应发送功能字
* 原封不动的发送回去
